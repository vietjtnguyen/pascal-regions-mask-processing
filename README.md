Workflow
--------

1. Put *all* label MAT files from person `foo` into `./per-person/foo`.
2. Run `./aggregate-changes.bash trainval personA personB personC`. For our specific situation the command will be `./aggregate-changes.bash trainval boyan jun chunyu nam-gyu viet`.
    - Replace `trainval` with `test` to aggregate test labels.
    - If there is overlap in the labels changed amongst different people the changes from the person later in the argument list will override previous changes.
    - For each person `foo` this script produces the following:
        - `per-person/foo-trainval-list.txt`: SHA1 hashes for each label in `foo`'s folder
        - `per-person/foo-trainval-diff.txt`: `sdiff` result between `foo`'s labels and original labels
        - `per-person/foo-trainval-changes.txt`: list of image names (e.g.  `2009_012345`) that have been changed in `foo`'s labels
    - The total set of changes is generated into `./all-trainval-changes.txt`
3. Run `./flatten-folder.bash ./aggregate/trainval ./flattened/trainval` in order to flatten the layers of each label and save them. Replace `trainval` with `test` to flatten test labels.
4. Send flattened files to Nam-Gyu for empty pixel processing.
    - Usually I just `tar cvf flattened.v0.tar ./flattened/trainval`.
5. Get filled files back from Nam-Gyu and put them in `./filled/trainval`. Note that Nam-Gyu's returning files use `LabelMap` for the variable name instead of `Label` so all following scripts use `LabelMap`.
6. Verify that there are no empty labels. `./check-labels.py findempty ./map/v1/aggregate-map.txt ./filled/trainval` should print nothing. Takes about one minute to run.
7. Remove any existing remapped folder: `rm -r ./remapped`
8. Apply mask-level corrections specified by index website which are stored in `./changes.pickle`. Apply these changes using `./apply-corrections.py ./map/v1/aggregate-map.txt ./changes.pickle ./filled/trainval ./remapped/v1.1/trainval`. Replace `trainval` with `test` to flatten test labels.
9. Copy files that were not corrected using `rsync -vrt --ignore-existing ./filled/trainval/* ./remapped/v1.1/trainval/`. Replace `trainval` with `test` to flatten test labels.
10. Verify that all of the files have been copied. `ls ./remapped/v1.1/trainval | wc -l` should return 10103 (for `trainval`).
11. Apply label-level corrections specified in Google Spreadsheet. Apply these changes using `./translate-labels.py ./map/v1-to-v2.txt ./map/v1/aggregate-map.txt ./remapped/v1.1/trainval ./map/v2/map.txt ./remapped/v2/trainval`. Replace `trainval` with `test` to flatten test labels. Keep an eye out for errors.

Folders
-------

- `aggregate`: Contains set folders (e.g. `trainval` and `test`) containing label MAT files from different labelers aggregated together.
- `all-images`: A folder containing symlinks to all (`trainval` and `test`) *original* images. Used to serve `index.py` website.
- `flattened`: Contains set folders (e.g. `trainval` and `test`) containing the aggregated labels flattened to a single layer.
- `map`: Contains version folders (e.g. `v1`, `v2`, etc.) containing label map information. These are the same maps read by the GIMP toolbox. `v1` contains `aggregate-map.txt` which is the combined label map from all labelers. Also contains translation mapping (e.g. `./map/v1-to-v2.txt`) determined by the Google Spreadsheet.
- `orig`: Contains set folders containing the original post-triage label MAT files.
- `per-person`: Contains a folder per labeler containing each labeler's *entire* label sets. They need to have all labels in a set because the changes are determined by a consistent diff of SHA1 hashes.
- `regions`: Contains the memoized masks generated by the `index.py` website. Can be cleared at any time.
- `remapped`: Contains version folders (e.g. `v2`) containing set folders (e.g. `trainval` and `test`) which contains label MAT files which are the output of `translate-labels.py`.
